<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlists</title>
  <link rel="stylesheet" href="style.css">
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00fff7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Music Library">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <meta name="msapplication-TileColor" content="#00fff7">
  <meta name="msapplication-TileImage" content="icons/icon-144x144.png">
</head>
<body>

<div class="top-nav">
    <div class="nav-left">
        <button class="nav-button" onclick="window.location.href='index.html'">
            &larr; Back to Home
        </button>
    </div>

    <div class="nav-right">
        <button class="nav-button" onclick="window.location.href='top-songs.html'" 
                style="background: linear-gradient(145deg, #ffd700, #ffaa00); color: black; margin-right: 10px;">
            ‚≠ê Top 50 Songs
        </button>
        
        <button class="nav-button" onclick="window.location.href='upload.html'">
            Go to Upload &rarr;
        </button>
    </div>
</div>

  <header>
    <h1>Your Playlists</h1>
    <p>Create playlists from your uploaded songs</p>
  </header>

  <section class="upload-section">

    <!-- CREATE PLAYLIST -->
    <div class="playlist-control-card">
      <h2>Create a Playlist</h2>
      <div class="input-group">
        <input type="text" id="playlistNameInput" placeholder="Enter playlist name" class="styled-input">
        <button id="createPlaylistBtn" class="cyber-button">Create Playlist</button>
      </div>
    </div>

    <!-- ADD SONG TO PLAYLIST -->
    <div class="playlist-control-card">
      <h2>Add Song to Playlist</h2>
      <div class="input-group">
        <input type="text" id="songSearchInput" placeholder="Loading songs..." class="styled-input">
        <div id="songSuggestions" class="suggestions-box"></div>
        <select id="playlistSelect" class="styled-select">
          <option value="">Select a playlist</option>
        </select>
        <button id="addSongBtn" class="cyber-button">Add Song</button>
        <button id="refreshSongsBtn" class="cyber-button" style="background: linear-gradient(145deg, #ff8800, #ffaa00);">
          üîÑ Refresh Songs
        </button>
      </div>
      <div id="loadingStatus" style="margin-top: 10px; color: #00fff7; font-size: 14px;">Connecting to database...</div>
    </div>

    <!-- PLAYLIST DISPLAY -->
    <div class="playlists-display">
      <h2>Your Playlists</h2>
      <div id="playlistsContainer" class="playlists-grid">
        <div class="empty-state" id="emptyState">
          <p>No playlists yet. Create your first one!</p>
        </div>
      </div>
    </div>

  </section>

  <!-- AUDIO PLAYER -->
  <div class="audio-player-container">
    <h2>Now Playing</h2>
    <audio id="audioPlayer" controls></audio>
  </div>

  <script>
    console.log("üéµ PLAYLIST PAGE - COMPLETE REWRITE WITH FIXES");
    
    // DOM elements
    const playlistNameInput = document.getElementById("playlistNameInput");
    const createPlaylistBtn = document.getElementById("createPlaylistBtn");
    const songSearchInput = document.getElementById("songSearchInput");
    const addSongBtn = document.getElementById("addSongBtn");
    const playlistSelect = document.getElementById("playlistSelect");
    const playlistsContainer = document.getElementById("playlistsContainer");
    const audioPlayer = document.getElementById("audioPlayer");
    const songSuggestions = document.getElementById("songSuggestions");
    const emptyState = document.getElementById("emptyState");
    const refreshSongsBtn = document.getElementById("refreshSongsBtn");
    const loadingStatus = document.getElementById("loadingStatus");

    // State variables
    let playlists = {};
    let availableSongs = [];
    let dbReady = false;
    
    // Database config - MUST match upload.html
    const DB_NAME = 'MusicAppDB_V2';
    const STORE_NAME = 'uploadedSongs';
    const DB_VERSION = 1;
    
    // ========== UTILITY FUNCTIONS ==========
    
    function updateLoadingStatus(message, isError = false) {
      if (loadingStatus) {
        loadingStatus.textContent = message;
        loadingStatus.style.color = isError ? '#ff4444' : '#00fff7';
      }
      console.log(message);
    }
    
    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
    }
    
    // ========== STORAGE FUNCTIONS ==========
    
    function loadPlaylistsFromStorage() {
      try {
        const stored = localStorage.getItem("musicPlaylists");
        console.log("üì¶ Loading from localStorage:", stored);
        
        if (!stored || stored === "null" || stored === "undefined") {
          console.log("No playlists in storage, starting fresh");
          playlists = {};
          return {};
        }
        
        const parsed = JSON.parse(stored);
        console.log("‚úÖ Parsed playlists:", parsed);
        
        // Verify the data structure
        if (typeof parsed !== 'object' || parsed === null) {
          console.warn("Invalid playlist data, resetting");
          playlists = {};
          return {};
        }
        
        playlists = parsed;
        console.log("‚úÖ Loaded playlists successfully:", playlists);
        return playlists;
      } catch (error) {
        console.error("‚ùå Error loading playlists:", error);
        playlists = {};
        return {};
      }
    }
    
    function savePlaylistsToStorage() {
      try {
        // Don't save if playlists is somehow undefined or null
        if (!playlists) {
          console.error("‚ùå Attempted to save null/undefined playlists - BLOCKED");
          return false;
        }
        
        const jsonString = JSON.stringify(playlists);
        
        // Don't save empty object if we previously had data
        const existing = localStorage.getItem("musicPlaylists");
        if (jsonString === '{}' && existing && existing !== '{}') {
          console.warn("‚ö†Ô∏è Attempted to save empty playlists when data exists - BLOCKED");
          console.warn("Existing data:", existing);
          console.warn("Use clearAllPlaylists() if you really want to delete everything");
          return false;
        }
        
        localStorage.setItem("musicPlaylists", jsonString);
        console.log("üíæ Saved to localStorage:", jsonString);
        console.log("Current playlists object:", playlists);
        
        // Verify it was saved
        const verification = localStorage.getItem("musicPlaylists");
        if (verification === jsonString) {
          console.log("‚úÖ Save verified successfully");
          return true;
        } else {
          console.error("‚ùå Save verification failed!");
          return false;
        }
      } catch (error) {
        console.error("‚ùå Error saving playlists:", error);
        return false;
      }
    }
    
    // ========== DATABASE FUNCTIONS ==========
    
    async function loadUploadedSongs() {
      console.log("üîç Loading songs from IndexedDB...");
      updateLoadingStatus("Loading songs from database...");
      
      return new Promise((resolve) => {
        if (!window.indexedDB) {
          console.error("‚ùå IndexedDB not supported");
          updateLoadingStatus("Browser doesn't support offline storage", true);
          resolve([]);
          return;
        }

        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = (event) => {
          console.error("‚ùå Database error:", event.target.error);
          updateLoadingStatus("Error opening database", true);
          resolve([]);
        };
        
        request.onsuccess = (event) => {
          const db = event.target.result;
          console.log("‚úÖ Database opened successfully");
          
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            console.log("‚ö†Ô∏è No songs store found");
            updateLoadingStatus("No songs uploaded yet. Go to Upload page.", true);
            db.close();
            dbReady = false;
            resolve([]);
            return;
          }
          
          try {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const getAllRequest = store.getAll();
            
            getAllRequest.onsuccess = () => {
              const songs = getAllRequest.result || [];
              console.log(`‚úÖ Loaded ${songs.length} songs:`, songs.map(s => s.name));
              
              if (songs.length > 0) {
                updateLoadingStatus(`‚úÖ Loaded ${songs.length} song${songs.length !== 1 ? 's' : ''}!`);
              } else {
                updateLoadingStatus("No songs in library", true);
              }
              
              dbReady = true;
              db.close();
              resolve(songs);
            };
            
            getAllRequest.onerror = (err) => {
              console.error("‚ùå Error reading songs:", err);
              updateLoadingStatus("Error reading songs", true);
              db.close();
              resolve([]);
            };
            
          } catch (error) {
            console.error("‚ùå Transaction error:", error);
            db.close();
            resolve([]);
          }
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { 
              keyPath: 'id', 
              autoIncrement: true 
            });
            store.createIndex('name', 'name', { unique: false });
          }
        };
      });
    }
    
    // ========== UI RENDERING FUNCTIONS ==========
    
    function updatePlaylistSelect() {
      console.log("üîÑ Updating playlist dropdown");
      playlistSelect.innerHTML = "<option value=''>Select a playlist</option>";
      
      Object.keys(playlists).forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = `${name} (${playlists[name].length} songs)`;
        playlistSelect.appendChild(option);
      });
      
      console.log("Dropdown updated with", Object.keys(playlists).length, "playlists");
    }
    
    function renderPlaylists() {
      console.log("üé® ===== RENDERING PLAYLISTS =====");
      console.log("Playlists object:", JSON.stringify(playlists, null, 2));
      
      const playlistNames = Object.keys(playlists);
      console.log("Playlist names:", playlistNames);
      
      if (playlistNames.length === 0) {
        console.log("‚ùå No playlists to render");
        emptyState.style.display = 'block';
        playlistsContainer.innerHTML = '<div class="empty-state"><p>No playlists yet. Create your first one!</p></div>';
        return;
      }
      
      emptyState.style.display = 'none';
      playlistsContainer.innerHTML = '';
      console.log("‚úÖ Container cleared, starting render...");
      
      playlistNames.forEach(name => {
        const songs = playlists[name] || [];
        console.log(`  üìù Playlist "${name}":`, {
          songCount: songs.length,
          songs: songs.map(s => ({ name: s.name, id: s.id }))
        });
        
        const card = document.createElement("div");
        card.className = "playlist-card";
        card.style.cssText = `
          background: #1a1a1a;
          border: 2px solid #00fff7;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
        `;
        
        // Build songs HTML
        let songsHTML = '';
        console.log(`    Building HTML for ${songs.length} songs...`);
        
        if (songs.length === 0) {
          console.log("    ‚ÑπÔ∏è Empty playlist, showing message");
          songsHTML = `
            <li style="color: #888; font-style: italic; padding: 15px; text-align: center; list-style: none;">
              No songs in this playlist yet. Add some above!
            </li>
          `;
        } else {
          console.log("    ‚úÖ Building song list HTML...");
          songsHTML = songs.map((song, i) => {
            const html = `
            <li class="song-item" style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px;
              border-bottom: 1px solid #333;
              list-style: none;
              transition: background 0.2s;
            " 
            onmouseenter="this.style.background='#222'"
            onmouseleave="this.style.background=''"
            data-song-name="${song.name}">
              <span style="flex: 1; color: #00fff7; margin-right: 15px;">
                üéµ ${song.name}
              </span>
              <div style="display: flex; gap: 8px; flex-shrink: 0;">
                <button class="play-single-btn" 
                        data-playlist-name="${name}" 
                        data-song-index="${i}"
                        style="
                          padding: 8px 16px;
                          background: linear-gradient(145deg, #00fff7, #00cccc);
                          color: black;
                          border: none;
                          border-radius: 4px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 14px;
                          transition: transform 0.2s;
                        "
                        onmouseenter="this.style.transform='scale(1.05)'"
                        onmouseleave="this.style.transform='scale(1)'">
                  ‚ñ∂ Play
                </button>
                <button class="remove-song" 
                        data-playlist-name="${name}" 
                        data-song-id="${song.id}"
                        data-song-name="${song.name}"
                        style="
                          padding: 8px 16px;
                          background: linear-gradient(145deg, #ff4444, #cc0000);
                          color: white;
                          border: none;
                          border-radius: 4px;
                          cursor: pointer;
                          font-weight: bold;
                          font-size: 14px;
                          transition: transform 0.2s;
                        "
                        onmouseenter="this.style.transform='scale(1.05)'"
                        onmouseleave="this.style.transform='scale(1)'">
                  √ó Remove
                </button>
              </div>
            </li>
          `;
            console.log(`      Song ${i+1}: "${song.name}" - HTML length: ${html.length} chars`);
            return html;
          }).join('');
          console.log(`    ‚úÖ Generated ${songsHTML.length} characters of HTML`);
        }
        
        console.log(`    üìÑ Building playlist card for "${name}"...`);
        const playlistCard = document.createElement("div");
        playlistCard.className = "playlist-card";
        playlistCard.style.cssText = `
          background: #1a1a1a;
          border: 2px solid #00fff7;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
        `;
        
        const cardHTML = `
          <div style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00fff7;
          ">
            <div>
              <h3 style="margin: 0 0 5px 0; color: #00fff7; font-size: 24px;">
                ${name}
              </h3>
              <span style="color: #aaa; font-size: 14px;">
                ${songs.length} song${songs.length !== 1 ? 's' : ''}
              </span>
            </div>
            <button class="delete-playlist" 
                    data-playlist-name="${name}"
                    style="
                      padding: 10px 20px;
                      background: linear-gradient(145deg, #ff4444, #cc0000);
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      font-weight: bold;
                      font-size: 14px;
                      transition: transform 0.2s;
                    "
                    onmouseenter="this.style.transform='scale(1.05)'"
                    onmouseleave="this.style.transform='scale(1)'">
              üóëÔ∏è Delete Playlist
            </button>
          </div>
          <ul style="margin: 0; padding: 0;">
            ${songsHTML}
          </ul>
        `;
        
        console.log(`    üìÑ Card HTML length: ${cardHTML.length} chars`);
        playlistCard.innerHTML = cardHTML;
        console.log(`    ‚ûï Appending card to container...`);
        playlistsContainer.appendChild(playlistCard);
        console.log(`    ‚úÖ Card appended for "${name}"`);
      });
      
      console.log("‚úÖ ===== ALL PLAYLISTS RENDERED =====");
      console.log("Final container children:", playlistsContainer.children.length);
    }
    
    // ========== SEARCH FUNCTIONALITY ==========
    
    function setupSongSearch() {
      console.log("üéØ Setting up search with", availableSongs.length, "songs");
      
      if (availableSongs.length > 0) {
        songSearchInput.placeholder = `Search ${availableSongs.length} songs...`;
        songSearchInput.disabled = false;
        addSongBtn.disabled = false;
      } else {
        songSearchInput.placeholder = "No songs available (upload songs first)";
        songSearchInput.disabled = false;
        addSongBtn.disabled = false;
      }
      
      songSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        
        if (!query) {
          songSuggestions.style.display = 'none';
          return;
        }
        
        if (availableSongs.length === 0) {
          songSuggestions.innerHTML = `
            <div style="position: absolute; z-index: 1000; background: #1a1a1a; border: 1px solid #ff4444; border-radius: 4px; padding: 15px; text-align: center; color: #ff4444; box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);">
              <p style="margin: 0 0 10px 0; font-weight: bold;">‚ö†Ô∏è No songs in your library</p>
              <p style="margin: 0 0 15px 0; font-size: 13px; color: #aaa;">Upload songs on the Upload page first</p>
              <button onclick="window.location.href='upload.html'" 
                      style="padding: 8px 16px; background: #00fff7; color: black; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                üì§ Go to Upload Page
              </button>
            </div>
          `;
          songSuggestions.style.display = 'block';
          return;
        }
        
        const filtered = availableSongs.filter(s => 
          s.name.toLowerCase().includes(query)
        ).slice(0, 10);
        
        if (filtered.length === 0) {
          songSuggestions.innerHTML = `
            <div style="padding: 10px; color: #888; text-align: center; background: #1a1a1a; border: 1px solid #333; border-radius: 4px;">
              No matches for "${query}"
            </div>
          `;
        } else {
          songSuggestions.innerHTML = filtered.map(song => `
            <div class="suggestion-item" data-song-name="${song.name}" 
                 style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a;">
              <span style="flex: 1;">${song.name}</span>
              <small style="color: #aaa; font-size: 11px;">${formatFileSize(song.size)}</small>
            </div>
          `).join('');
          
          songSuggestions.querySelectorAll('.suggestion-item').forEach(item => {
            item.onclick = (e) => {
              e.stopPropagation();
              songSearchInput.value = item.dataset.songName;
              songSuggestions.style.display = 'none';
            };
            item.onmouseenter = () => item.style.backgroundColor = '#222';
            item.onmouseleave = () => item.style.backgroundColor = '#1a1a1a';
          });
        }
        
        songSuggestions.style.display = 'block';
        songSuggestions.style.position = 'absolute';
        songSuggestions.style.zIndex = '1000';
        songSuggestions.style.background = '#1a1a1a';
        songSuggestions.style.border = '1px solid #00fff7';
        songSuggestions.style.borderRadius = '4px';
        songSuggestions.style.maxHeight = '300px';
        songSuggestions.style.overflowY = 'auto';
        songSuggestions.style.marginTop = '2px';
        songSuggestions.style.boxShadow = '0 4px 12px rgba(0, 255, 247, 0.3)';
      });
      
      document.addEventListener('click', (e) => {
        if (!songSearchInput.contains(e.target) && !songSuggestions.contains(e.target)) {
          songSuggestions.style.display = 'none';
        }
      });
      
      songSearchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') songSuggestions.style.display = 'none';
      });
    }
    
    // ========== EVENT HANDLERS ==========
    
    createPlaylistBtn.addEventListener("click", () => {
      const name = playlistNameInput.value.trim();
      
      console.log("üÜï Creating playlist:", name);
      
      if (!name) {
        alert("Please enter a playlist name");
        return;
      }
      
      if (playlists[name]) {
        alert("A playlist with this name already exists");
        return;
      }
      
      // Create new playlist
      playlists[name] = [];
      console.log("Created playlist, current playlists:", playlists);
      
      // Save to storage
      const saved = savePlaylistsToStorage();
      console.log("Save result:", saved);
      
      // Update UI
      updatePlaylistSelect();
      renderPlaylists();
      playlistNameInput.value = "";
      
      // Visual feedback
      createPlaylistBtn.textContent = `‚úì Created "${name}"!`;
      createPlaylistBtn.style.background = "linear-gradient(145deg, #00ff88, #00cc66)";
      setTimeout(() => {
        createPlaylistBtn.textContent = "Create Playlist";
        createPlaylistBtn.style.background = "";
      }, 2000);
    });
    
    addSongBtn.addEventListener("click", () => {
      const playlistName = playlistSelect.value;
      const searchName = songSearchInput.value.trim();
      
      console.log("‚ûï Adding song:", searchName, "to playlist:", playlistName);
      
      if (!playlistName) {
        alert("Please select a playlist first");
        return;
      }
      
      if (!searchName) {
        alert("Please type or select a song name");
        return;
      }
      
      if (availableSongs.length === 0) {
        if (confirm("No songs in your library. Go to Upload page?")) {
          window.location.href = 'upload.html';
        }
        return;
      }

      // Find song
      const song = availableSongs.find(s => 
        s.name.toLowerCase() === searchName.toLowerCase() ||
        s.name.toLowerCase().includes(searchName.toLowerCase())
      );
      
      console.log("Found song:", song);
      
      if (!song) {
        alert(`Song "${searchName}" not found in your library.`);
        return;
      }

      // Check if already in playlist
      if (playlists[playlistName].some(s => s.id === song.id)) {
        alert(`"${song.name}" is already in this playlist`);
        return;
      }

      // Add to playlist
      playlists[playlistName].push(song);
      console.log("Added song. Playlist now has:", playlists[playlistName]);
      
      // Save
      const saved = savePlaylistsToStorage();
      console.log("Save result:", saved);
      
      // Update UI
      updatePlaylistSelect();
      renderPlaylists();
      
      songSearchInput.value = "";
      songSuggestions.style.display = 'none';
      
      // Visual feedback
      addSongBtn.textContent = `‚úì Added "${song.name}"!`;
      addSongBtn.style.background = "linear-gradient(145deg, #00ff88, #00cc66)";
      setTimeout(() => {
        addSongBtn.textContent = "Add Song";
        addSongBtn.style.background = "";
      }, 2000);
    });
    
    refreshSongsBtn.addEventListener('click', async () => {
      console.log("üîÑ Manual refresh");
      updateLoadingStatus("Refreshing...");
      refreshSongsBtn.disabled = true;
      refreshSongsBtn.textContent = "üîÑ Loading...";
      
      await new Promise(r => setTimeout(r, 300));
      
      availableSongs = await loadUploadedSongs();
      
      if (availableSongs.length > 0) {
        songSearchInput.placeholder = `Search ${availableSongs.length} songs...`;
      } else {
        songSearchInput.placeholder = "No songs available";
      }
      
      refreshSongsBtn.disabled = false;
      refreshSongsBtn.textContent = "üîÑ Refresh Songs";
      
      if (availableSongs.length > 0) {
        setTimeout(() => updateLoadingStatus(""), 3000);
      }
    });
    
    // Event delegation for playlist actions
    playlistsContainer.addEventListener('click', (e) => {
      // Delete playlist
      if (e.target.classList.contains('delete-playlist')) {
        const name = e.target.dataset.playlistName;
        console.log("üóëÔ∏è Deleting playlist:", name);
        
        if (confirm(`Delete playlist "${name}"?`)) {
          delete playlists[name];
          savePlaylistsToStorage();
          updatePlaylistSelect();
          renderPlaylists();
        }
      }
      
      // Remove song
      if (e.target.classList.contains('remove-song')) {
        const playlistName = e.target.dataset.playlistName;
        const songName = e.target.dataset.songName;
        console.log("‚ûñ Removing song:", songName, "from:", playlistName);
        
        const idx = playlists[playlistName].findIndex(s => s.name === songName);
        if (idx > -1) {
          playlists[playlistName].splice(idx, 1);
          savePlaylistsToStorage();
          updatePlaylistSelect();
          renderPlaylists();
        }
      }
      
      // Play song
      if (e.target.classList.contains('play-single-btn')) {
        const playlistName = e.target.dataset.playlistName;
        const songIndex = parseInt(e.target.dataset.songIndex);
        const song = playlists[playlistName][songIndex];
        if (song) playSong(song);
      }
    });
    
    // ========== AUDIO PLAYBACK ==========
    
    async function playSong(song) {
      console.log("‚ñ∂ Playing:", song.name);
      
      try {
        const byteChars = atob(song.data);
        const byteNums = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) {
          byteNums[i] = byteChars.charCodeAt(i);
        }
        const bytes = new Uint8Array(byteNums);
        const blob = new Blob([bytes], { type: song.type || 'audio/mpeg' });
        const url = URL.createObjectURL(blob);
        
        if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
          URL.revokeObjectURL(audioPlayer.src);
        }
        
        audioPlayer.src = url;
        audioPlayer.load();
        await audioPlayer.play();
        
        document.querySelectorAll('.song-item').forEach(item => {
          item.classList.toggle('playing', item.dataset.songName === song.name);
        });
        
        audioPlayer.addEventListener('ended', () => URL.revokeObjectURL(url), { once: true });
        
      } catch (error) {
        console.error("‚ùå Playback error:", error);
        alert("Could not play song: " + error.message);
      }
    }
    
    // ========== KEYBOARD SHORTCUTS ==========
    
    playlistNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') createPlaylistBtn.click();
    });
    
    songSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addSongBtn.click();
    });
    
    // ========== INITIALIZATION ==========
    
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("üöÄ Initializing playlist page...");
      
      // Step 1: Load playlists from storage FIRST
      console.log("Step 1: Loading playlists from storage...");
      const loadedPlaylists = loadPlaylistsFromStorage();
      console.log("Playlists loaded:", loadedPlaylists);
      console.log("Playlists object after load:", playlists);
      
      // Verify playlists loaded correctly
      if (Object.keys(playlists).length > 0) {
        console.log("‚úÖ Found existing playlists:", Object.keys(playlists));
      } else {
        console.log("‚ÑπÔ∏è No existing playlists found");
      }
      
      // Step 2: Load songs from database
      console.log("Step 2: Loading songs from database...");
      availableSongs = await loadUploadedSongs();
      console.log(`üìö Loaded ${availableSongs.length} songs`);
      
      // Step 3: Update UI (in correct order)
      console.log("Step 3: Updating UI...");
      updatePlaylistSelect();
      console.log("Step 4: Rendering playlists...");
      renderPlaylists();
      console.log("Step 5: Setting up search...");
      setupSongSearch();
      
      // Clear status after success
      if (availableSongs.length > 0) {
        setTimeout(() => updateLoadingStatus(""), 3000);
      }
      
      console.log("‚úÖ Initialization complete");
      console.log("Final state - Playlists:", JSON.stringify(playlists, null, 2));
    });
    
    // ========== DEBUG FUNCTIONS ==========
    
    window.debugPlaylist = () => {
      console.log("=== PLAYLIST DEBUG INFO ===");
      console.log("Available songs:", availableSongs.length);
      console.log("Songs:", availableSongs);
      console.log("Playlists (memory):", playlists);
      console.log("Playlists (JSON):", JSON.stringify(playlists, null, 2));
      console.log("LocalStorage raw:", localStorage.getItem("musicPlaylists"));
      console.log("Database ready:", dbReady);
      
      // Check if data matches
      const stored = localStorage.getItem("musicPlaylists");
      const storedObj = stored ? JSON.parse(stored) : {};
      console.log("Storage matches memory?", JSON.stringify(storedObj) === JSON.stringify(playlists));
    };
    
    window.reloadPlaylists = () => {
      console.log("üîÑ Force reloading playlists...");
      loadPlaylistsFromStorage();
      updatePlaylistSelect();
      renderPlaylists();
    };
    
    window.clearAllPlaylists = () => {
      if (confirm("‚ö†Ô∏è Delete ALL playlists? This cannot be undone!")) {
        playlists = {};
        localStorage.removeItem("musicPlaylists");
        updatePlaylistSelect();
        renderPlaylists();
        console.log("‚úÖ All playlists cleared");
      }
    };
    
    window.checkStorage = () => {
      console.log("=== STORAGE CHECK ===");
      const raw = localStorage.getItem("musicPlaylists");
      console.log("Raw localStorage:", raw);
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          console.log("Parsed:", parsed);
          console.log("Number of playlists:", Object.keys(parsed).length);
          Object.keys(parsed).forEach(name => {
            console.log(`  - "${name}": ${parsed[name].length} songs`);
          });
        } catch (e) {
          console.error("Parse error:", e);
        }
      } else {
        console.log("‚ùå No data in localStorage");
      }
    };
  </script>

</body>
</html>